---
const measurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID
const isDev = import.meta.env.DEV
---

{measurementId && (
  <>
    <!-- Google tag (gtag.js) - Following Daniel's Ultimate Astro GA Guide -->
    <script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${measurementId}`}></script>
    <script is:inline define:vars={{ measurementId }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      window.gtag = gtag;
      gtag('js', new Date());
      
      // GDPR Compliant - Default consent to denied
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied'
      });
      
      // Configure GA4 with privacy settings
      gtag('config', measurementId, {
        anonymize_ip: true,
        allow_google_signals: false,
        allow_ad_personalization_signals: false,
        debug_mode: false,
        send_page_view: true
      });
      
      // View Transitions support - Reinitialize on page changes
      document.addEventListener('astro:page-load', () => {
        gtag('js', new Date());
        gtag('config', measurementId);
      });
      
      // Custom tracking functions
      window.trackQuoteRequest = function(quoteData) {
        gtag('event', 'generate_lead', {
          currency: 'USD',
          value: quoteData.estimatedValue || 0
        });
      };
      
      window.trackFileUpload = function(fileData) {
        gtag('event', 'file_upload', {
          file_extension: fileData.fileType,
          file_name: fileData.fileName
        });
      };
      
      window.trackContactForm = function(formType) {
        gtag('event', 'form_submit', {
          form_type: formType || 'contact'
        });
      };
    </script>
  </>
)}

<!-- 确保自定义跟踪函数始终可用 -->
<script is:inline>
  // 定义自定义跟踪函数（如果还不存在）
  window.trackQuoteRequest = window.trackQuoteRequest || function(quoteData) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'generate_lead', {
        currency: 'USD',
        value: quoteData.estimatedValue || 0
      });
    }
  };
  
  window.trackFileUpload = window.trackFileUpload || function(fileData) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'file_upload', {
        file_extension: fileData.fileType,
        file_name: fileData.fileName
      });
    }
  };
  
  window.trackContactForm = window.trackContactForm || function(formType) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'form_submit', {
        form_type: formType || 'contact'
      });
    }
  };
</script>

