---
// AI报价表单组件 - 集成Supabase
---

<form id="ai-quote-form" class="space-y-8">
  <!-- 用户信息 -->
  <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
      👤 联系信息
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="ai-name" class="block text-sm font-semibold text-gray-700 mb-2">
          姓名 *
        </label>
        <input 
          type="text" 
          id="ai-name" 
          name="name" 
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          placeholder="请输入您的姓名"
        >
      </div>
      
      <div>
        <label for="ai-email" class="block text-sm font-semibold text-gray-700 mb-2">
          邮箱地址 *
        </label>
        <input 
          type="email" 
          id="ai-email" 
          name="email" 
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          placeholder="your.email@company.com"
        >
      </div>
      
      <div>
        <label for="ai-company" class="block text-sm font-semibold text-gray-700 mb-2">
          公司名称
        </label>
        <input 
          type="text" 
          id="ai-company" 
          name="company"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          placeholder="公司名称"
        >
      </div>
      
      <div>
        <label for="ai-phone" class="block text-sm font-semibold text-gray-700 mb-2">
          联系电话
        </label>
        <input 
          type="tel" 
          id="ai-phone" 
          name="phone"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          placeholder="138 xxxx xxxx"
        >
      </div>
    </div>
  </div>

  <!-- 项目信息 -->
  <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
      🔧 项目要求
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="ai-material" class="block text-sm font-semibold text-gray-700 mb-2">
          材料类型 *
        </label>
        <select 
          id="ai-material" 
          name="material" 
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
        >
          <option value="">请选择材料</option>
          <option value="6061-t6">6061-T6 铝合金</option>
          <option value="7075-t6">7075-T6 铝合金</option>
          <option value="2024-t3">2024-T3 铝合金</option>
          <option value="304-stainless">304 不锈钢</option>
          <option value="316l-stainless">316L 不锈钢</option>
          <option value="17-4ph-stainless">17-4PH 不锈钢</option>
          <option value="ti-6al-4v">Ti-6Al-4V 钛合金</option>
          <option value="grade-2-titanium">Grade 2 钛合金</option>
          <option value="c360-brass">C360 黄铜</option>
          <option value="peek">PEEK 工程塑料</option>
          <option value="pom">POM 塑料</option>
          <option value="other">其他材料</option>
        </select>
      </div>
      
      <div>
        <label for="ai-quantity" class="block text-sm font-semibold text-gray-700 mb-2">
          数量 *
        </label>
        <input 
          type="number" 
          id="ai-quantity" 
          name="quantity" 
          min="1" 
          value="1" 
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          placeholder="请输入数量"
        >
      </div>
      
      <div>
        <label for="ai-precision" class="block text-sm font-semibold text-gray-700 mb-2">
          精度要求
        </label>
        <select 
          id="ai-precision" 
          name="precision"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
        >
          <option value="standard">标准精度 (±0.1mm)</option>
          <option value="high">高精度 (±0.05mm)</option>
          <option value="ultra">超高精度 (±0.02mm)</option>
          <option value="extreme">极限精度 (±0.01mm)</option>
        </select>
      </div>
      
      <div>
        <label for="ai-delivery" class="block text-sm font-semibold text-gray-700 mb-2">
          期望交期
        </label>
        <select 
          id="ai-delivery" 
          name="delivery"
          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
        >
          <option value="standard">标准交期 (3-5天)</option>
          <option value="fast">加急交期 (1-2天)</option>
          <option value="express">特急交期 (24小时)</option>
          <option value="immediate">极急交期 (12小时)</option>
        </select>
      </div>
    </div>
    
    <div class="mt-4">
      <label for="ai-requirements" class="block text-sm font-semibold text-gray-700 mb-2">
        特殊要求说明
      </label>
      <textarea 
        id="ai-requirements" 
        name="requirements" 
        rows="3"
        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300 resize-none"
        placeholder="请描述任何特殊要求，如表面处理、热处理、认证需求等..."
      ></textarea>
    </div>
  </div>

  <!-- 文件上传 -->
  <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
      📁 CAD图纸上传
    </h3>
    
    <div class="border-2 border-dashed border-orange-300 rounded-xl p-8 text-center hover:border-orange-400 transition-colors duration-300" id="ai-upload-zone">
      <input 
        type="file" 
        id="ai-cad-files" 
        name="files" 
        multiple 
        accept=".step,.stp,.stl,.iges,.igs,.dwg,.dxf,.obj,.ply,.3mf"
        class="hidden"
      >
      <label for="ai-cad-files" class="cursor-pointer">
        <svg class="w-16 h-16 text-orange-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"></path>
        </svg>
        <div class="text-gray-700 mb-2">
          <span class="font-semibold text-orange-600">点击上传CAD文件</span> 或拖拽文件到此处
        </div>
        <div class="text-sm text-gray-500">
          支持: STEP, STL, IGES, DWG, DXF, OBJ, PLY, 3MF (最大50MB)
        </div>
      </label>
    </div>
    
    <div id="ai-file-list" class="mt-4 space-y-2 hidden">
      <!-- 文件列表将在这里显示 -->
    </div>
  </div>

  <!-- 提交按钮 -->
  <div class="text-center pt-6">
    <button 
      type="submit" 
      id="ai-submit-btn"
      class="bg-gradient-to-r from-yellow-400 to-orange-500 text-purple-900 px-12 py-4 rounded-full text-xl font-bold hover:from-yellow-300 hover:to-orange-400 transform hover:scale-105 transition-all duration-300 shadow-2xl"
    >
      <span id="ai-submit-text">🚀 获取AI智能报价</span>
      <span id="ai-loading-text" class="hidden">🔄 正在处理...</span>
    </button>
    
    <div class="mt-4 text-sm text-gray-600">
      📊 预计分析时间：3-5秒 | 🔒 您的数据安全受保护
    </div>
  </div>

  <!-- 成功消息 -->
  <div id="ai-success-message" class="hidden bg-green-50 border border-green-200 rounded-xl p-6">
    <div class="flex items-start space-x-3">
      <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <h4 class="text-green-800 font-semibold mb-2">✅ 报价请求提交成功！</h4>
        <p class="text-green-700 mb-4">
          您的CAD文件已上传成功，我们的AI系统正在进行分析。请等待报价结果显示。
        </p>
        <div class="space-y-2 text-sm text-green-600">
          <div>• AI分析完成后，将显示详细的成本分解</div>
          <div>• 专业工程师将在4-8小时内进行技术复核</div>
          <div>• 最终报价将通过邮件发送给您</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 错误消息 -->
  <div id="ai-error-message" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
    <div class="flex items-start space-x-3">
      <svg class="w-6 h-6 text-red-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <h4 class="text-red-800 font-semibold mb-2">❌ 提交失败</h4>
        <p class="text-red-700 mb-2" id="ai-error-text">
          抱歉，提交过程中出现了问题。请重试或直接联系我们。
        </p>
        <div class="space-y-1 text-sm text-red-600">
          <div>• 技术支持：<strong>400-XXX-XXXX</strong></div>
          <div>• 邮箱：<strong>support@geppetto.com</strong></div>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  import { submitQuoteRequest, uploadFile } from '../../utils/supabase.js';

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('ai-quote-form');
    const fileInput = document.getElementById('ai-cad-files');
    const fileList = document.getElementById('ai-file-list');
    const uploadZone = document.getElementById('ai-upload-zone');
    const submitBtn = document.getElementById('ai-submit-btn');
    const submitText = document.getElementById('ai-submit-text');
    const loadingText = document.getElementById('ai-loading-text');
    const successMessage = document.getElementById('ai-success-message');
    const errorMessage = document.getElementById('ai-error-message');
    const errorText = document.getElementById('ai-error-text');

    let selectedFiles = [];

    // 文件上传处理
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // 拖拽上传
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('border-orange-400', 'bg-orange-50');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('border-orange-400', 'bg-orange-50');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('border-orange-400', 'bg-orange-50');
      
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    // 点击上传区域
    uploadZone.addEventListener('click', () => {
      fileInput.click();
    });

    function handleFiles(files) {
      selectedFiles = Array.from(files);
      displayFileList();
      validateFiles();
    }

    function displayFileList() {
      if (selectedFiles.length === 0) {
        fileList.classList.add('hidden');
        return;
      }

      fileList.classList.remove('hidden');
      fileList.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border';
        
        const fileExtension = file.name.split('.').pop().toUpperCase();
        const fileSize = formatFileSize(file.size);
        const iconColor = getFileIconColor(fileExtension);
        
        fileItem.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 ${iconColor} rounded-lg flex items-center justify-center">
              <span class="text-white text-xs font-bold">${fileExtension}</span>
            </div>
            <div>
              <div class="font-medium text-gray-800">${file.name}</div>
              <div class="text-sm text-gray-500">${fileSize}</div>
            </div>
          </div>
          <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 p-1">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>
        `;
        
        fileList.appendChild(fileItem);
      });
    }

    function getFileIconColor(extension) {
      const colorMap = {
        'STEP': 'bg-blue-500', 'STP': 'bg-blue-500',
        'STL': 'bg-purple-500',
        'IGES': 'bg-green-500', 'IGS': 'bg-green-500',
        'DWG': 'bg-orange-500', 'DXF': 'bg-orange-500',
        'OBJ': 'bg-pink-500', 'PLY': 'bg-indigo-500',
        '3MF': 'bg-red-500'
      };
      return colorMap[extension] || 'bg-gray-500';
    }

    function validateFiles() {
      const maxSize = 50 * 1024 * 1024; // 50MB
      const allowedTypes = ['.step', '.stp', '.stl', '.iges', '.igs', '.dwg', '.dxf', '.obj', '.ply', '.3mf'];
      
      for (const file of selectedFiles) {
        if (file.size > maxSize) {
          showError(`文件 "${file.name}" 超过50MB大小限制`);
          return false;
        }
        
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(extension)) {
          showError(`文件 "${file.name}" 格式不支持`);
          return false;
        }
      }
      return true;
    }

    // 表单提交处理
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // 验证文件
      if (selectedFiles.length === 0) {
        showError('请至少上传一个CAD文件');
        return;
      }

      if (!validateFiles()) {
        return;
      }

      // 显示加载状态
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      loadingText.classList.remove('hidden');
      
      // 隐藏之前的消息
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      try {
        // 先上传文件
        const uploadPromises = selectedFiles.map(file => uploadFile(file));
        const uploadResults = await Promise.all(uploadPromises);
        const fileUrls = uploadResults.map(result => result.url);

        // 准备报价请求数据
        const formData = new FormData(form);
        const quoteData = {
          name: formData.get('name'),
          email: formData.get('email'),
          company: formData.get('company') || '',
          phone: formData.get('phone') || '',
          material: formData.get('material'),
          quantity: parseInt(formData.get('quantity')),
          requirements: formData.get('requirements') || '',
          file_urls: fileUrls,
          status: 'pending'
        };

        // 提交到Supabase
        const result = await submitQuoteRequest(quoteData);

        // 成功
        successMessage.classList.remove('hidden');
        form.reset();
        selectedFiles = [];
        displayFileList();
        
        // 追踪转化事件
        if (typeof gtag !== 'undefined') {
          gtag('event', 'ai_quote_submit', {
            'event_category': 'engagement',
            'event_label': 'ai_quote_page',
            'value': quoteData.quantity
          });
        }

        // 可选：触发AI分析流程
        if (result && result[0]) {
          console.log('Quote request submitted:', result[0]);
          // 这里可以触发AI分析流程或显示进度
        }

      } catch (error) {
        console.error('AI报价提交错误:', error);
        showError(error.message || '提交失败，请稍后重试');
      } finally {
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        loadingText.classList.add('hidden');
      }
    });

    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      
      // 滚动到错误消息
      errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 全局函数用于删除文件
    window.removeFile = (index) => {
      selectedFiles.splice(index, 1);
      displayFileList();
    };
  });
</script>