---
// æŠ¥ä»·è¿›åº¦æ¡ç»„ä»¶ - ä¸‰é˜¶æ®µæµç¨‹å±•ç¤º (æ”¯æŒå¤šè¯­è¨€)
interface Props {
  language?: 'zh' | 'en';
}

const { language = 'zh' } = Astro.props;

// å¤šè¯­è¨€æ–‡æœ¬é…ç½®
const text = {
  zh: {
    title: 'ğŸš€ Geppettoæ™ºèƒ½æŠ¥ä»·è¿›è¡Œä¸­',
    subtitle: 'AI+ä¸“å®¶åŒé‡ä¿éšœï¼Œç¡®ä¿æŠ¥ä»·ç²¾å‡†å¯é ',
    stage1: {
      title: 'ğŸ¤– AIæ™ºèƒ½è®¡ç®—',
      subtitle: 'å‡ ä½•åˆ†æ + å·¥è‰ºè¯†åˆ«',
      details: [
        'â€¢ 3Då‡ ä½•å½¢çŠ¶è§£æ',
        'â€¢ æœ€ä¼˜åŠ å·¥è·¯å¾„',
        'â€¢ ææ–™ç”¨é‡è®¡ç®—'
      ],
      eta: 'é¢„è®¡ï¼š1-2ç§’'
    },
    stage2: {
      title: 'ğŸ‘¨â€ğŸ”¬ ä¸“å®¶ä¼˜åŒ–å®¡æ ¸',
      subtitle: 'è´¨é‡æŠŠæ§ + æˆæœ¬ä¼˜åŒ–',
      details: [
        'â€¢ å·¥è‰ºå¯è¡Œæ€§éªŒè¯',
        'â€¢ æˆæœ¬ç»“æ„ä¼˜åŒ–',
        'â€¢ é£é™©è¯„ä¼°æ’æŸ¥'
      ],
      eta: 'é¢„è®¡ï¼š1-2ç§’'
    },
    stage3: {
      title: 'ğŸ“‹ ç”Ÿæˆç²¾å‡†æŠ¥ä»·',
      subtitle: 'è¯¦ç»†æ¸…å• + äº¤æœŸæ‰¿è¯º',
      details: [
        'â€¢ è¯¦ç»†æˆæœ¬åˆ†è§£',
        'â€¢ ç²¾ç¡®äº¤æœŸè®¡ç®—',
        'â€¢ è´¨é‡ä¿è¯æ¡æ¬¾'
      ],
      eta: 'é¢„è®¡ï¼š1ç§’'
    },
    status: {
      initializing: 'æ­£åœ¨åˆå§‹åŒ–AIåˆ†æå¼•æ“...',
      message: 'è¯·ç¨å€™ï¼Œæˆ‘ä»¬çš„AI+ä¸“å®¶å›¢é˜Ÿæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæœ€ä¼˜æŠ¥ä»·æ–¹æ¡ˆ',
      aiRunning: 'AIç®—æ³•è¿è¡Œä¸­',
      expertStandby: 'ä¸“å®¶å¾…å‘½å®¡æ ¸',
      eta: 'é¢„è®¡å®Œæˆæ—¶é—´',
      stages: {
        1: {
          title: 'ğŸ¤– AIæ™ºèƒ½åˆ†æè¿›è¡Œä¸­...',
          message: 'AIç®—æ³•æ­£åœ¨è§£ææ‚¨çš„CADå›¾çº¸ï¼Œåˆ†æå‡ ä½•ç»“æ„å’Œåˆ¶é€ å·¥è‰ºè¦æ±‚'
        },
        2: {
          title: 'ğŸ‘¨â€ğŸ”¬ ä¸“å®¶ä¼˜åŒ–å®¡æ ¸ä¸­...',
          message: 'èµ„æ·±å·¥ç¨‹å¸ˆæ­£åœ¨éªŒè¯AIåˆ†æç»“æœï¼Œä¼˜åŒ–æˆæœ¬ç»“æ„å’Œå·¥è‰ºæ–¹æ¡ˆ'
        },
        3: {
          title: 'ğŸ“‹ ç”Ÿæˆç²¾å‡†æŠ¥ä»·ä¸­...',
          message: 'æ­£åœ¨æ•´åˆåˆ†æç»“æœï¼Œç”Ÿæˆè¯¦ç»†çš„æŠ¥ä»·å•å’Œäº¤æœŸæ‰¿è¯º'
        }
      },
      complete: {
        title: 'âœ… æŠ¥ä»·ç”Ÿæˆå®Œæˆï¼',
        message: 'æ­å–œï¼æ‚¨çš„æ™ºèƒ½æŠ¥ä»·å·²å‡†å¤‡å°±ç»ªï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è¯¦ç»†ç»“æœã€‚'
      }
    },
    values: [
      {
        title: 'ç§’çº§ç²¾å‡†',
        description: 'AIç®—æ³•3ç§’å®Œæˆä¼ ç»Ÿäººå·¥3å°æ—¶çš„æŠ¥ä»·å·¥ä½œ'
      },
      {
        title: 'ä¸“å®¶ä¿éšœ',
        description: '10å¹´+ç»éªŒä¸“å®¶å®¡æ ¸ç¡®ä¿æ¯ä¸ªæŠ¥ä»·å‡†ç¡®å¯é '
      },
      {
        title: 'æˆæœ¬é€æ˜',
        description: 'è¯¦ç»†æˆæœ¬åˆ†è§£ï¼Œä»·æ ¼æ¯”å¸‚åœºå¹³å‡ä½30-50%'
      }
    ]
  },
  en: {
    title: 'ğŸš€ Geppetto AI Quote in Progress',
    subtitle: 'AI + Expert dual guarantee for precise and reliable quotes',
    stage1: {
      title: 'ğŸ¤– AI Smart Analysis',
      subtitle: 'Geometry parsing + Process identification',
      details: [
        'â€¢ 3D geometry analysis',
        'â€¢ Optimal machining paths',
        'â€¢ Material usage calculation'
      ],
      eta: 'ETA: 1-2 seconds'
    },
    stage2: {
      title: 'ğŸ‘¨â€ğŸ”¬ Expert Technical Review',
      subtitle: 'Quality control + Cost optimization',
      details: [
        'â€¢ Process feasibility verification',
        'â€¢ Cost structure optimization',
        'â€¢ Risk assessment evaluation'
      ],
      eta: 'ETA: 4-8 hours'
    },
    stage3: {
      title: 'ğŸ“‹ Precise Quote Generation',
      subtitle: 'Detailed breakdown + Delivery commitment',
      details: [
        'â€¢ Detailed cost breakdown',
        'â€¢ Precise delivery calculation',
        'â€¢ Quality guarantee terms'
      ],
      eta: 'ETA: Email notification'
    },
    status: {
      initializing: 'Initializing AI Analysis Engine...',
      message: 'Please wait, our AI + Expert team is generating the optimal quote solution for you',
      aiRunning: 'AI algorithm running',
      expertStandby: 'Expert standby for review',
      eta: 'ETA',
      stages: {
        1: {
          title: 'ğŸ¤– AI Smart Analysis in Progress...',
          message: 'AI algorithm is parsing your CAD drawings, analyzing geometric structures and manufacturing process requirements'
        },
        2: {
          title: 'ğŸ‘¨â€ğŸ”¬ Expert Technical Review in Progress...',
          message: 'Senior engineers are verifying AI analysis results, optimizing cost structure and process solutions'
        },
        3: {
          title: 'ğŸ“‹ Generating Precise Quote...',
          message: 'Integrating analysis results, generating detailed quote and delivery commitment'
        }
      },
      complete: {
        title: 'âœ… Quote Generation Complete!',
        message: 'Congratulations! Your AI-powered quote is ready. Please check your email for detailed results.'
      }
    },
    values: [
      {
        title: 'Lightning Precision',
        description: 'AI completes in 3 seconds what traditional manual quoting takes 3 hours'
      },
      {
        title: 'Expert Assurance',
        description: '10+ years experienced experts review every quote for accuracy and reliability'
      },
      {
        title: 'Cost Transparency',
        description: 'Detailed cost breakdown, prices 30-50% below market average'
      }
    ]
  }
};

const currentText = text[language];
---

<div id="quote-progress-section" class="hidden py-12">
  <div class="max-w-4xl mx-auto">
    <!-- è¿›åº¦æ¡æ ‡é¢˜ -->
    <div class="text-center mb-8">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">
        {currentText.title}
      </h3>
      <p class="text-gray-600">
        {currentText.subtitle}
      </p>
    </div>

    <!-- ä¸‰é˜¶æ®µè¿›åº¦æ¡ -->
    <div class="relative">
      <!-- è¿›åº¦çº¿ -->
      <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 rounded-full transform -translate-y-1/2 z-0">
        <div id="progress-line" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
      </div>
      
      <!-- ä¸‰ä¸ªé˜¶æ®µ -->
      <div class="relative flex justify-between items-center z-10">
        
        <!-- é˜¶æ®µ1: AIè®¡ç®— -->
        <div class="quote-stage flex flex-col items-center group" id="stage-1">
          <div class="stage-circle w-16 h-16 rounded-full border-4 border-gray-300 bg-white flex items-center justify-center mb-4 transition-all duration-500">
            <div class="stage-icon hidden">
              <svg class="w-8 h-8 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="stage-spinner hidden">
              <svg class="w-8 h-8 text-purple-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </div>
            <div class="stage-number text-gray-400 font-bold text-xl">1</div>
          </div>
          
          <div class="text-center max-w-xs">
            <h4 class="font-bold text-gray-800 mb-2">{currentText.stage1.title}</h4>
            <p class="text-sm text-gray-600 mb-1">{currentText.stage1.subtitle}</p>
            <div class="stage-details text-xs text-gray-500 space-y-1">
              {currentText.stage1.details.map((detail, index) => (
                <div class="detail-item opacity-50" data-detail={`detail-${index}`}>{detail}</div>
              ))}
            </div>
            <div class="stage-time text-xs text-purple-600 font-semibold mt-2">{currentText.stage1.eta}</div>
          </div>
        </div>

        <!-- é˜¶æ®µ2: ä¸“å®¶ä¼˜åŒ–å®¡æ ¸ -->
        <div class="quote-stage flex flex-col items-center group" id="stage-2">
          <div class="stage-circle w-16 h-16 rounded-full border-4 border-gray-300 bg-white flex items-center justify-center mb-4 transition-all duration-500">
            <div class="stage-icon hidden">
              <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="stage-spinner hidden">
              <svg class="w-8 h-8 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            </div>
            <div class="stage-number text-gray-400 font-bold text-xl">2</div>
          </div>
          
          <div class="text-center max-w-xs">
            <h4 class="font-bold text-gray-800 mb-2">{currentText.stage2.title}</h4>
            <p class="text-sm text-gray-600 mb-1">{currentText.stage2.subtitle}</p>
            <div class="stage-details text-xs text-gray-500 space-y-1">
              {currentText.stage2.details.map((detail, index) => (
                <div class="detail-item opacity-50" data-detail={`detail-${index}`}>{detail}</div>
              ))}
            </div>
            <div class="stage-time text-xs text-blue-600 font-semibold mt-2">{currentText.stage2.eta}</div>
          </div>
        </div>

        <!-- é˜¶æ®µ3: è¾“å‡ºæŠ¥ä»· -->
        <div class="quote-stage flex flex-col items-center group" id="stage-3">
          <div class="stage-circle w-16 h-16 rounded-full border-4 border-gray-300 bg-white flex items-center justify-center mb-4 transition-all duration-500">
            <div class="stage-icon hidden">
              <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="stage-spinner hidden">
              <svg class="w-8 h-8 text-green-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <div class="stage-number text-gray-400 font-bold text-xl">3</div>
          </div>
          
          <div class="text-center max-w-xs">
            <h4 class="font-bold text-gray-800 mb-2">{currentText.stage3.title}</h4>
            <p class="text-sm text-gray-600 mb-1">{currentText.stage3.subtitle}</p>
            <div class="stage-details text-xs text-gray-500 space-y-1">
              {currentText.stage3.details.map((detail, index) => (
                <div class="detail-item opacity-50" data-detail={`detail-${index}`}>{detail}</div>
              ))}
            </div>
            <div class="stage-time text-xs text-green-600 font-semibold mt-2">{currentText.stage3.eta}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
    <div class="mt-8 text-center">
      <div id="current-status" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-6">
        <div class="flex items-center justify-center space-x-3 mb-4">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </div>
          <h4 id="status-title" class="text-lg font-bold text-gray-800">{currentText.status.initializing}</h4>
        </div>
        
        <p id="status-message" class="text-gray-600 mb-4">
          {currentText.status.message}
        </p>
        
        <div class="flex items-center justify-center space-x-4 text-sm text-gray-500">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span>{currentText.status.aiRunning}</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
            <span>{currentText.status.expertStandby}</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
            <span>{currentText.status.eta}: <span id="total-eta">{language === 'en' ? '5 seconds' : '5ç§’'}</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»·å€¼æ‰¿è¯º -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl p-6 border border-purple-100 hover:shadow-lg transition-shadow duration-300">
        <div class="text-center">
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h5 class="font-bold text-gray-800 mb-2">{currentText.values[0].title}</h5>
          <p class="text-sm text-gray-600">{currentText.values[0].description}</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 border border-blue-100 hover:shadow-lg transition-shadow duration-300">
        <div class="text-center">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h5 class="font-bold text-gray-800 mb-2">{currentText.values[1].title}</h5>
          <p class="text-sm text-gray-600">{currentText.values[1].description}</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 border border-green-100 hover:shadow-lg transition-shadow duration-300">
        <div class="text-center">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h5 class="font-bold text-gray-800 mb-2">{currentText.values[2].title}</h5>
          <p class="text-sm text-gray-600">{currentText.values[2].description}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
export class QuoteProgressController {
  constructor() {
    this.currentStage = 0;
    this.totalStages = 3;
    this.stageElements = [];
    this.isRunning = false;
    
    this.init();
  }

  init() {
    // è·å–æ‰€æœ‰é˜¶æ®µå…ƒç´ 
    for (let i = 1; i <= this.totalStages; i++) {
      this.stageElements.push(document.getElementById(`stage-${i}`));
    }
    
    this.progressLine = document.getElementById('progress-line');
    this.statusTitle = document.getElementById('status-title');
    this.statusMessage = document.getElementById('status-message');
    this.totalEta = document.getElementById('total-eta');
  }

  show() {
    const section = document.getElementById('quote-progress-section');
    section?.classList.remove('hidden');
    return this;
  }

  hide() {
    const section = document.getElementById('quote-progress-section');
    section?.classList.add('hidden');
    return this;
  }

  start() {
    if (this.isRunning) return;
    
    this.isRunning = true;
    this.currentStage = 0;
    this.show();
    
    // é‡ç½®æ‰€æœ‰é˜¶æ®µ
    this.resetAllStages();
    
    // å¼€å§‹ç¬¬ä¸€é˜¶æ®µ
    setTimeout(() => this.startStage(1), 500);
    
    return this;
  }

  startStage(stageNumber) {
    if (stageNumber > this.totalStages) {
      this.complete();
      return;
    }

    this.currentStage = stageNumber;
    const stageElement = this.stageElements[stageNumber - 1];
    
    if (!stageElement) return;

    // æ›´æ–°è¿›åº¦çº¿
    const progressPercentage = ((stageNumber - 1) / this.totalStages) * 100;
    this.progressLine.style.width = `${progressPercentage}%`;

    // è®¾ç½®å½“å‰é˜¶æ®µä¸ºè¿›è¡Œä¸­
    this.setStageActive(stageElement, stageNumber);
    
    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
    this.updateStatus(stageNumber);
    
    // æ¨¡æ‹Ÿé˜¶æ®µå¤„ç†æ—¶é—´
    const stageDuration = this.getStageDuration(stageNumber);
    
    setTimeout(() => {
      this.completeStage(stageElement, stageNumber);
      
      // è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
      setTimeout(() => {
        this.startStage(stageNumber + 1);
      }, 500);
    }, stageDuration);
  }

  setStageActive(stageElement, stageNumber) {
    const circle = stageElement.querySelector('.stage-circle');
    const number = stageElement.querySelector('.stage-number');
    const spinner = stageElement.querySelector('.stage-spinner');
    const details = stageElement.querySelectorAll('.detail-item');
    
    // è®¾ç½®åœ†åœˆä¸ºæ´»åŠ¨çŠ¶æ€
    circle.className = 'stage-circle w-16 h-16 rounded-full border-4 border-purple-500 bg-purple-50 flex items-center justify-center mb-4 transition-all duration-500';
    
    // éšè—æ•°å­—ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    number.classList.add('hidden');
    spinner.classList.remove('hidden');
    
    // æ¿€æ´»ç»†èŠ‚é¡¹ç›®
    details.forEach((detail, index) => {
      setTimeout(() => {
        detail.classList.remove('opacity-50');
        detail.classList.add('opacity-100', 'text-purple-600');
      }, index * 300);
    });
  }

  completeStage(stageElement, stageNumber) {
    const circle = stageElement.querySelector('.stage-circle');
    const icon = stageElement.querySelector('.stage-icon');
    const spinner = stageElement.querySelector('.stage-spinner');
    const details = stageElement.querySelectorAll('.detail-item');
    
    // è®¾ç½®åœ†åœˆä¸ºå®ŒæˆçŠ¶æ€
    const colors = ['purple', 'blue', 'green'];
    const color = colors[stageNumber - 1];
    circle.className = `stage-circle w-16 h-16 rounded-full border-4 border-${color}-500 bg-${color}-500 flex items-center justify-center mb-4 transition-all duration-500`;
    
    // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå®Œæˆå›¾æ ‡
    spinner.classList.add('hidden');
    icon.classList.remove('hidden');
    
    // æ ‡è®°æ‰€æœ‰ç»†èŠ‚ä¸ºå®Œæˆ
    details.forEach(detail => {
      detail.classList.add('line-through', 'text-green-600');
    });

    // æ›´æ–°è¿›åº¦çº¿
    const progressPercentage = (stageNumber / this.totalStages) * 100;
    this.progressLine.style.width = `${progressPercentage}%`;
  }

  resetAllStages() {
    this.stageElements.forEach((stageElement, index) => {
      if (!stageElement) return;
      
      const circle = stageElement.querySelector('.stage-circle');
      const number = stageElement.querySelector('.stage-number');
      const icon = stageElement.querySelector('.stage-icon');
      const spinner = stageElement.querySelector('.stage-spinner');
      const details = stageElement.querySelectorAll('.detail-item');
      
      // é‡ç½®åœ†åœˆ
      circle.className = 'stage-circle w-16 h-16 rounded-full border-4 border-gray-300 bg-white flex items-center justify-center mb-4 transition-all duration-500';
      
      // æ˜¾ç¤ºæ•°å­—ï¼Œéšè—å…¶ä»–
      number.classList.remove('hidden');
      icon.classList.add('hidden');
      spinner.classList.add('hidden');
      
      // é‡ç½®ç»†èŠ‚é¡¹ç›®
      details.forEach(detail => {
        detail.className = 'detail-item opacity-50';
      });
    });
    
    // é‡ç½®è¿›åº¦çº¿
    this.progressLine.style.width = '0%';
  }

  updateStatus(stageNumber) {
    const stageInfo = window.quoteProgressText?.status.stages || {
      1: {
        title: 'ğŸ¤– AIæ™ºèƒ½åˆ†æè¿›è¡Œä¸­...',
        message: 'AIç®—æ³•æ­£åœ¨è§£ææ‚¨çš„CADå›¾çº¸ï¼Œåˆ†æå‡ ä½•ç»“æ„å’Œåˆ¶é€ å·¥è‰ºè¦æ±‚'
      },
      2: {
        title: 'ğŸ‘¨â€ğŸ”¬ ä¸“å®¶ä¼˜åŒ–å®¡æ ¸ä¸­...',
        message: 'èµ„æ·±å·¥ç¨‹å¸ˆæ­£åœ¨éªŒè¯AIåˆ†æç»“æœï¼Œä¼˜åŒ–æˆæœ¬ç»“æ„å’Œå·¥è‰ºæ–¹æ¡ˆ'
      },
      3: {
        title: 'ğŸ“‹ ç”Ÿæˆç²¾å‡†æŠ¥ä»·ä¸­...',
        message: 'æ­£åœ¨æ•´åˆåˆ†æç»“æœï¼Œç”Ÿæˆè¯¦ç»†çš„æŠ¥ä»·å•å’Œäº¤æœŸæ‰¿è¯º'
      }
    };
    
    const info = stageInfo[stageNumber];
    if (info) {
      this.statusTitle.textContent = info.title;
      this.statusMessage.textContent = info.message;
    }
    
    // æ›´æ–°å‰©ä½™æ—¶é—´
    const remainingTime = this.getRemainingTime(stageNumber);
    const language = window.quoteProgressLanguage || 'zh';
    this.totalEta.textContent = stageNumber === 2 && language === 'en' ? '4-8 hours' : `${remainingTime}${language === 'en' ? ' seconds' : 'ç§’'}`;
  }

  getStageDuration(stageNumber) {
    // å„é˜¶æ®µæŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    const durations = [2000, 1500, 1000]; // AIè®¡ç®—2ç§’ï¼Œä¸“å®¶å®¡æ ¸1.5ç§’ï¼Œè¾“å‡ºæŠ¥ä»·1ç§’
    return durations[stageNumber - 1] || 1000;
  }

  getRemainingTime(currentStage) {
    const remainingStages = this.totalStages - currentStage + 1;
    return Math.max(1, remainingStages);
  }

  complete() {
    this.isRunning = false;
    
    // æ›´æ–°æœ€ç»ˆçŠ¶æ€
    const completeText = window.quoteProgressText?.status.complete || {
      title: 'âœ… æŠ¥ä»·ç”Ÿæˆå®Œæˆï¼',
      message: 'æ­å–œï¼æ‚¨çš„æ™ºèƒ½æŠ¥ä»·å·²å‡†å¤‡å°±ç»ªï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è¯¦ç»†ç»“æœã€‚'
    };
    this.statusTitle.textContent = completeText.title;
    this.statusMessage.textContent = completeText.message;
    const language = window.quoteProgressLanguage || 'zh';
    this.totalEta.textContent = language === 'en' ? 'Complete' : 'å·²å®Œæˆ';
    
    // è§¦å‘å®Œæˆäº‹ä»¶
    const event = new CustomEvent('quoteProgressComplete', {
      detail: { timestamp: new Date().toISOString() }
    });
    document.dispatchEvent(event);
    
    // 3ç§’åéšè—è¿›åº¦æ¡
    setTimeout(() => {
      this.hide();
    }, 3000);
  }

  // å¤–éƒ¨æ¥å£æ–¹æ³•
  updateProgress(stage, details = {}) {
    if (stage === 'ai-analysis') {
      this.startStage(1);
    } else if (stage === 'expert-review') {
      this.startStage(2);
    } else if (stage === 'quote-generation') {
      this.startStage(3);
    } else if (stage === 'complete') {
      this.complete();
    }
  }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
window.QuoteProgressController = QuoteProgressController;

// å½“DOMåŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  window.quoteProgress = new QuoteProgressController();
});
</script>

<!-- è®¾ç½®å…¨å±€å˜é‡ä»¥æ”¯æŒå¤šè¯­è¨€ -->
<script define:vars={{ language, currentText }}>
  // è®¾ç½®å…¨å±€å˜é‡ä¾› JavaScript ä½¿ç”¨
  window.quoteProgressLanguage = language;
  window.quoteProgressText = currentText;
</script>
</script>

<style>
  /* è¿›åº¦æ¡ä¸“ç”¨æ ·å¼ */
  .quote-stage {
    position: relative;
  }
  
  .stage-circle {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .quote-stage:hover .stage-circle {
    transform: scale(1.05);
  }
  
  .detail-item {
    transition: all 0.3s ease;
  }
  
  .stage-time {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .quote-stage:hover .stage-time {
    opacity: 1;
  }
  
  @media (max-width: 768px) {
    .quote-stage {
      margin-bottom: 2rem;
    }
    
    .relative {
      flex-direction: column;
    }
    
    .stage-circle {
      width: 3rem;
      height: 3rem;
    }
    
    .absolute {
      display: none;
    }
  }
</style>